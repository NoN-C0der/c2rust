name: Rust CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Clean up existing LLVM
      run: |
        sudo apt-get remove -y '^llvm-.*' '^clang-.*' || true
        sudo apt-get autoremove -y
        sudo apt-get clean
    
    - name: Install LLVM 15.0 from Ubuntu repositories
      run: |
        sudo apt-get update
        
        # Используем только стандартные репозитории Ubuntu для избежания конфликтов
        sudo apt-get install -y \
          llvm-15 \
          llvm-15-dev \
          llvm-15-tools \
          clang-15 \
          clang-15-doc \
          libclang-common-15-dev \
          libclang-cpp15 \
          libclang-15-dev \
          liblld-15-dev \
          liblldb-15-dev \
          lld-15 \
          lldb-15
        
        # Не устанавливаем libpolly-15-dev если он вызывает конфликты
        # Polly может быть не обязательной для вашего проекта
        echo "LLVM_SYS_150_PREFIX=/usr/lib/llvm-15" >> $GITHUB_ENV
    
    - name: Verify LLVM installation
      run: |
        echo "LLVM prefix: $LLVM_SYS_150_PREFIX"
        ls -la /usr/lib/llvm-15/lib/ || true
        llvm-config-15 --version || true
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
