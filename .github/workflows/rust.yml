name: Rust CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04  # Используйте Ubuntu 22.04 вместо 24.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install LLVM 15.0
      run: |
        sudo apt-get update
        
        # Для Ubuntu 22.04 используем официальный репозиторий LLVM
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-15 main"
        sudo apt-get update
        sudo apt-get install -y llvm-15 llvm-15-dev clang-15 libclang-15-dev libpolly-15-dev
        
        echo "LLVM_SYS_150_PREFIX=/usr/lib/llvm-15" >> $GITHUB_ENV
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
